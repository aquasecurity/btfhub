name: Update BTFHub Archive
on:
  schedule:
    - cron: "0 1 * * *"
  workflow_dispatch: {}
jobs:
  build:
    name: Update BTF Archive
    runs-on: ubuntu-22.04
    steps:
      #
      - name: Check out BTFHub
        uses: actions/checkout@v3
        with:
          path: ./btfhub
      #
      - name: Checkout BTFHub Archive
        uses: actions/checkout@v3
        with:
          repository: aquasecurity/btfhub-archive
          token: ${{ secrets.ORG_GITHUB_TOKEN }}
          path: ./btfhub-archive
      #
      - name: Install Dependencies
        uses: ./.github/actions/build-dependencies
      #
      - name: Bring current BTFHub Archive
        run: |
          cd btfhub
          make bring
      #
      - name: Compile BTFHub Tool
        run: |
          cd btfhub
          make
      #
      - name: Fetch and Generate new BTFs
        run: |
          cd btfhub
          ./btfhub -workers 10 -d ubuntu
      #
      - name: Take new BTFs to BTFHub Archive
        run: |
          cd btfhub
          make take
      #
      - name: Check Status
        run: |
          cd btfhub-archive
          git status
      #
      # - name: Commit and Push to BTFHub repo
      #   run: |
      #     cd btfhub-archive-repo
      #     git config --local user.email "action@github.com"
      #     git config --local user.name "GitHub Action"
      #     git add -A
      #     git diff-index --quiet HEAD || git commit -m "Update BTF Archives"
      #     git push
